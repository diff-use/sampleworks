apiVersion: batch/v1
kind: Job
metadata:
  name: sampleworks-rf3
  labels:
    app: sampleworks
    model: rf3
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: sampleworks
        model: rf3
    spec:
      restartPolicy: Never
      containers:
      - name: sampleworks
        image: sampleworks:latest
        imagePullPolicy: IfNotPresent
        args:
        - "-e"
        - "rf3"
        - "run_grid_search.py"
        - "--proteins"
        - "/data/input/proteins.csv"
        - "--models"
        - "rf3"
        - "--scalers"
        - "pure_guidance"
        - "--partial-diffusion-step"
        - "120"
        - "--ensemble-sizes"
        - "8"
        - "--gradient-weights"
        - "0.01 0.02 0.05"
        - "--gradient-normalization"
        - "--augmentation"
        - "--align-to-input"
        - "--output-dir"
        - "/data/results"
        - "--rf3-checkpoint"
        - "/mnt/diffuse-private/raw/checkpoints/rf3_foundry_01_24_latest.ckpt"
        resources:
          limits:
            nvidia.com/gpu: 2
        volumeMounts:
        - name: dshm
          mountPath: /dev/shm
        - name: data-input
          mountPath: /data/input
          readOnly: true
        - name: data-results
          mountPath: /data/results
        - name: msa-cache
          mountPath: /root/.sampleworks/msa
        - name: checkpoints
          mountPath: /mnt/diffuse-private
          readOnly: true
      volumes:
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 16Gi
      - name: data-input
        hostPath:
          path: /mnt/diffuse-private/raw/sampleworks/initial_dataset_40
          type: Directory
      - name: data-results
        hostPath:
          path: /home/ubuntu/sampleworks-exp/grid_search_results
          type: DirectoryOrCreate
      - name: msa-cache
        hostPath:
          path: /home/ubuntu/sampleworks-exp/msa_cache
          type: DirectoryOrCreate
      - name: checkpoints
        hostPath:
          path: /mnt/diffuse-private
          type: Directory
